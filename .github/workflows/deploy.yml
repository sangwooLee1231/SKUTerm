name: Deploy to Azure VMSS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"


      - name: Build (Gradle)
        working-directory: ./SKU_Term
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}


      - name: Upload artifacts to Blob
        shell: bash
        run: |
          set -euo pipefail
          JAR_PATH=$(ls SKU_Term/build/libs/*.jar | head -n 1)
          SHA=${GITHUB_SHA::7}
          BLOB_JAR="app-${SHA}.jar"
          echo "BLOB_JAR=$BLOB_JAR" >> $GITHUB_ENV

          az storage blob upload \
            --account-name "${{ secrets.ST_ACCOUNT }}" \
            --container-name "${{ secrets.ST_CONTAINER }}" \
            --name "$BLOB_JAR" \
            --file "$JAR_PATH" \
            --overwrite true \
            --auth-mode login


      - name: Generate SAS (short-lived)
        shell: bash
        run: |
          set -euo pipefail
          EXPIRY=$(date -u -d "+1 hour" '+%Y-%m-%dT%H:%MZ')

          JAR_SAS=$(az storage blob generate-sas \
            --account-name "${{ secrets.ST_ACCOUNT }}" \
            --container-name "${{ secrets.ST_CONTAINER }}" \
            --name "${{ env.BLOB_JAR }}" \
            --permissions r \
            --expiry "$EXPIRY" \
            --https-only \
            --as-user \
            --auth-mode login \
            -o tsv)

          DEPLOY_SAS=$(az storage blob generate-sas \
            --account-name "${{ secrets.ST_ACCOUNT }}" \
            --container-name "${{ secrets.ST_CONTAINER }}" \
            --name "deploy.sh" \
            --permissions r \
            --expiry "$EXPIRY" \
            --https-only \
            --as-user \
            --auth-mode login \
            -o tsv)

          echo "JAR_URL=https://${{ secrets.ST_ACCOUNT }}.blob.core.windows.net/${{ secrets.ST_CONTAINER }}/${{ env.BLOB_JAR }}?$JAR_SAS" >> $GITHUB_ENV
          echo "DEPLOY_URL=https://${{ secrets.ST_ACCOUNT }}.blob.core.windows.net/${{ secrets.ST_CONTAINER }}/deploy.sh?$DEPLOY_SAS" >> $GITHUB_ENV

      - name: Update VMSS CustomScript (Rolling)
        shell: bash
        run: |
          set -euo pipefail
          RG="${{ secrets.RG_NAME }}"
          VMSS="${{ secrets.VMSS_NAME }}"

          az vmss extension set \
            --resource-group "$RG" \
            --vmss-name "$VMSS" \
            --name CustomScript \
            --publisher Microsoft.Azure.Extensions \
            --version 2.1 \
            --settings "{\"fileUris\":[\"${{ env.DEPLOY_URL }}\"],\"commandToExecute\":\"bash deploy.sh '${{ env.JAR_URL }}'\"}" \
            --force-update
